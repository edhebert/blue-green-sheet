{# templates/forgot-password.twig #}
{% extends "_layout" %}

{% block content %}
<div class="login-container">
    <div id="alert-container"></div>

    <div id="form-container">
        <h2>Forgot Your Password?</h2>
        <p>Enter your email address and we'll send you a link to reset your password.</p>

        <form id="forgot-password-form" method="post" accept-charset="UTF-8">
            {{ csrfInput() }}
            {{ actionInput('users/send-password-reset-email') }}

            <div class="form-group">
                <label for="loginName">Email Address</label>
                <input type="email"
                       id="loginName"
                       name="loginName"
                       required
                       autofocus>
            </div>

            <button type="submit" class="button rounded-pill mt-4" style="width: 100%">Send Reset Link</button>
        </form>
        <p class="center"><a href="/login">Back to Login</a></p>
    </div>

    <div id="success-container" style="display: none;">
        <h2>Check Your Email</h2>
        <p>If an account exists with that email address, we've sent you a link to reset your password.</p>
        <p class="center"><a href="/login">Back to Login</a></p>
    </div>
</div>

<script>
document.getElementById('forgot-password-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const button = form.querySelector('button[type="submit"]');
    const alertContainer = document.getElementById('alert-container');

    // Disable button and show loading state
    button.disabled = true;
    button.textContent = 'Sending...';

    // Clear previous alerts
    alertContainer.innerHTML = '';

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Craft's user controller always returns success for security
        // (doesn't reveal whether email exists or not)
        // So we just show success message after submission
        document.getElementById('form-container').style.display = 'none';
        document.getElementById('success-container').style.display = 'block';
    })
    .catch(error => {
        // Only show error if request completely failed
        alertContainer.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
        button.disabled = false;
        button.textContent = 'Send Reset Link';
    });
});
</script>

<style>
.login-container {
    max-width: 400px;
    margin: 2rem auto;
    padding: 2rem;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: bold;
}

.form-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.error {
    color: #d32f2f;
    margin-bottom: 1rem;
}

.alert {
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.375rem;
}

.alert-success {
    color: #0f5132;
    background-color: #d1e7dd;
    border-color: #badbcc;
}

.alert-danger {
    color: #842029;
    background-color: #f8d7da;
    border-color: #f5c2c7;
}

</style>
{% endblock %}
