{% extends "_layout.twig" %}

{% block title %}Job Opportunities Â· {{ siteName }}{% endblock %}

{% block content %}
{# Get current filter parameters and normalize to arrays #}
{% set regionParam = craft.app.request.getParam('region') %}
{% set categoryParam = craft.app.request.getParam('category') %}
{% set stateParam = craft.app.request.getParam('state') %}
{% set limitParam = craft.app.request.getParam('limit', 25) %}

{# Convert comma-separated strings to arrays #}
{% if regionParam %}
    {% set regionParams = regionParam|split(',') %}
{% else %}
    {% set regionParams = [] %}
{% endif %}

{% if categoryParam %}
    {% set categoryParams = categoryParam|split(',') %}
{% else %}
    {% set categoryParams = [] %}
{% endif %}

{% if stateParam %}
    {% set stateParams = stateParam|split(',') %}
{% else %}
    {% set stateParams = [] %}
{% endif %}

{# Validate pagination parameters #}
{% set allowedLimits = [25, 50, 100] %}
{% set currentLimit = limitParam in allowedLimits ? limitParam : 25 %}

{% set currentFilters = {
    region: regionParams,
    category: categoryParams,
    state: stateParams
} %}

{# Build job query based on active filters #}
{% set jobQuery = craft.entries().section('jobs') %}

{# Build relatedTo array for AND logic across different field types #}
{% set relatedToConditions = [] %}

{% if currentFilters.region|length %}
    {% set relatedToConditions = relatedToConditions|merge([{
        targetElement: currentFilters.region,
        field: 'jobRegion'
    }]) %}
{% endif %}

{% if currentFilters.category|length %}
    {% set relatedToConditions = relatedToConditions|merge([{
        targetElement: currentFilters.category,
        field: 'jobCategory'
    }]) %}
{% endif %}

{# Apply AND logic across different filter types #}
{% if relatedToConditions|length %}
    {% if relatedToConditions|length == 1 %}
        {% set jobQuery = jobQuery.relatedTo(relatedToConditions[0]) %}
    {% else %}
        {% set jobQuery = jobQuery.relatedTo(['and']|merge(relatedToConditions)) %}
    {% endif %}
{% endif %}

{% if currentFilters.state|length %}
    {% set jobQuery = jobQuery.jobState(currentFilters.state) %}
{% endif %}

{# Use Craft's paginate tag #}
{% paginate jobQuery.limit(currentLimit) as pageInfo, jobs %}

<div class="container-fluid">
    <div class="row">
        {# Sidebar Filters #}
        <aside class="col-lg-3 col-xl-2 mb-4">
            <div class="card border-0 shadow-sm position-sticky" style="top: 1rem; max-height: calc(100vh - 2rem); overflow-y: auto;">
                <div class="card-header bg-light border-0 sticky-top bg-white">
                    <h3 class="h6 mb-0">Filter Jobs</h3>
                </div>
                <div class="card-body">
                    {# Clear All Filters #}
                    {% if currentFilters.region|length or currentFilters.category|length or currentFilters.state|length %}
                        <div class="mb-3 pb-3 border-bottom">
                            <a href="{{ craft.app.request.url|split('?')[0] }}" class="btn btn-outline-danger btn-sm w-100">
                                Clear All Filters
                            </a>
                        </div>
                    {% endif %}

                    {# Filter Accordion #}
                    <div class="accordion accordion-flush" id="filterAccordion">
                        {# Regions Filter #}
                        <div class="accordion-item border-0 mb-3">
                            <h4 class="accordion-header">
                                <button class="accordion-button collapsed bg-transparent border-0 p-0 shadow-none h6 mb-0"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#regionsCollapse"
                                        aria-expanded="{{ currentFilters.region|length ? 'true' : 'false' }}"
                                        aria-controls="regionsCollapse">
                                    <span class="me-auto">Regions</span>
                                    {% if currentFilters.region|length %}
                                        <span class="badge bg-primary me-2">{{ currentFilters.region|length }}</span>
                                    {% endif %}
                                </button>
                            </h4>
                            <div id="regionsCollapse" class="accordion-collapse collapse {{ currentFilters.region|length ? 'show' : '' }}" data-bs-parent="#filterAccordion">
                                <div class="accordion-body p-0 pt-2">
                                    {% for region in craft.categories().group('jobRegion').all() %}
                                        {% set isActive = region.id in currentFilters.region %}
                                        <div class="form-check mb-2">
                                            <input type="checkbox"
                                                   class="form-check-input filter-checkbox"
                                                   id="region-{{ region.id }}"
                                                   data-filter-type="region"
                                                   data-filter-value="{{ region.id }}"
                                                   {{ isActive ? 'checked' : '' }}>
                                            <label class="form-check-label small" for="region-{{ region.id }}">
                                                {{ region.title }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        {# Job Categories Filter #}
                        <div class="accordion-item border-0 mb-3">
                            <h4 class="accordion-header">
                                <button class="accordion-button collapsed bg-transparent border-0 p-0 shadow-none h6 mb-0"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#categoriesCollapse"
                                        aria-expanded="{{ currentFilters.category|length ? 'true' : 'false' }}"
                                        aria-controls="categoriesCollapse">
                                    <span class="me-auto">Job Categories</span>
                                    {% if currentFilters.category|length %}
                                        <span class="badge bg-primary me-2">{{ currentFilters.category|length }}</span>
                                    {% endif %}
                                </button>
                            </h4>
                            <div id="categoriesCollapse" class="accordion-collapse collapse {{ currentFilters.category|length ? 'show' : '' }}" data-bs-parent="#filterAccordion">
                                <div class="accordion-body p-0 pt-2">
                                    {% for category in craft.categories().group('jobCategories').all() %}
                                        {% set isActive = category.id in currentFilters.category %}
                                        <div class="form-check mb-2">
                                            <input type="checkbox"
                                                   class="form-check-input filter-checkbox"
                                                   id="category-{{ category.id }}"
                                                   data-filter-type="category"
                                                   data-filter-value="{{ category.id }}"
                                                   {{ isActive ? 'checked' : '' }}>
                                            <label class="form-check-label small" for="category-{{ category.id }}">
                                                {{ category.title }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        {# States Filter #}
                        {% set availableStates = craft.entries().section('jobs').jobState(':notempty:').orderBy('jobState').all()|group('jobState') %}
                        {% if availableStates|length %}
                        <div class="accordion-item border-0 mb-3">
                            <h4 class="accordion-header">
                                <button class="accordion-button collapsed bg-transparent border-0 p-0 shadow-none h6 mb-0"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#statesCollapse"
                                        aria-expanded="{{ currentFilters.state ? 'true' : 'false' }}"
                                        aria-controls="statesCollapse">
                                    <span class="me-auto">States</span>
                                    {% if currentFilters.state|length %}
                                        <span class="badge bg-primary me-2">{{ currentFilters.state|length }}</span>
                                    {% endif %}
                                </button>
                            </h4>
                            <div id="statesCollapse" class="accordion-collapse collapse {{ currentFilters.state|length ? 'show' : '' }}" data-bs-parent="#filterAccordion">
                                <div class="accordion-body p-0 pt-2">
                                    {# Show actual states from job entries #}
                                    {% for state, stateJobs in availableStates %}
                                        {% if state %}
                                            {% set isActive = state in currentFilters.state %}
                                            <div class="form-check mb-2">
                                                <input type="checkbox"
                                                       class="form-check-input filter-checkbox"
                                                       id="state-{{ state|replace({' ': '-'})|lower }}"
                                                       data-filter-type="state"
                                                       data-filter-value="{{ state }}"
                                                       {{ isActive ? 'checked' : '' }}>
                                                <label class="form-check-label small" for="state-{{ state|replace({' ': '-'})|lower }}">
                                                    {{ state }} <span class="text-muted">({{ stateJobs|length }})</span>
                                                </label>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {# Active Filters Summary #}
                    {% if currentFilters.region|length or currentFilters.category|length or currentFilters.state|length %}
                        <div class="border-top pt-3">
                            <h5 class="h6 mb-2">Active Filters:</h5>
                            <div class="d-flex flex-wrap gap-1">
                                {% if currentFilters.region|length %}
                                    {% for regionId in currentFilters.region %}
                                        {% set regionName = craft.categories().id(regionId).one().title %}
                                        <span class="badge bg-primary">
                                            {{ regionName }}
                                            <button type="button"
                                                    class="btn-close btn-close-white ms-1 remove-filter"
                                                    data-filter-type="region"
                                                    data-filter-value="{{ regionId }}"
                                                    aria-label="Remove {{ regionName }} filter"
                                                    style="font-size: 0.7em;"></button>
                                        </span>
                                    {% endfor %}
                                {% endif %}

                                {% if currentFilters.category|length %}
                                    {% for categoryId in currentFilters.category %}
                                        {% set categoryName = craft.categories().id(categoryId).one().title %}
                                        <span class="badge bg-secondary">
                                            {{ categoryName }}
                                            <button type="button"
                                                    class="btn-close btn-close-white ms-1 remove-filter"
                                                    data-filter-type="category"
                                                    data-filter-value="{{ categoryId }}"
                                                    aria-label="Remove {{ categoryName }} filter"
                                                    style="font-size: 0.7em;"></button>
                                        </span>
                                    {% endfor %}
                                {% endif %}

                                {% if currentFilters.state|length %}
                                    {% for state in currentFilters.state %}
                                        <span class="badge bg-warning text-dark">
                                            {{ state }}
                                            <button type="button"
                                                    class="btn-close ms-1 remove-filter"
                                                    data-filter-type="state"
                                                    data-filter-value="{{ state }}"
                                                    aria-label="Remove {{ state }} filter"
                                                    style="font-size: 0.7em;"></button>
                                        </span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </aside>

        {# Main Content Area #}
        <main class="col-lg-9 col-xl-10">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="h3 mb-1">Job Opportunities</h1>
                    <p class="text-muted mb-0">
                        Showing {{ jobs|length }} of {{ pageInfo.total }} position{{ pageInfo.total != 1 ? 's' : '' }}
                        {% if pageInfo.totalPages > 1 %}
                            (Page {{ pageInfo.currentPage }} of {{ pageInfo.totalPages }})
                        {% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    {# Results per page selector #}
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {{ currentLimit }} per page
                        </button>
                        <ul class="dropdown-menu">
                            {% for limit in allowedLimits %}
                                <li>
                                    <a class="dropdown-item {{ currentLimit == limit ? 'active' : '' }}"
                                       href="{{ craft.app.request.url|split('?')[0] }}?{{ craft.app.request.queryStringWithoutPath|replace({('limit=' ~ currentLimit): ('limit=' ~ limit), ('page=' ~ pageInfo.currentPage): 'page=1'}) }}{% if not craft.app.request.queryStringWithoutPath %}limit={{ limit }}{% else %}&limit={{ limit }}{% endif %}">
                                        {{ limit }} per page
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>

                    {% if jobs|length > 1 %}
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Sort by
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-sort="newest">Newest First</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="title">Title A-Z</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="location">Location</a></li>
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Job Results #}
            {% if jobs|length %}
                <div class="row g-4" id="jobResults">
                    {% for job in jobs %}
                        <div class="col-lg-6 col-xl-4 job-card-wrapper">
                            <article class="card h-100 border-0 shadow-sm job-card">
                                <div class="card-body">
                                    <h2 class="h6 mb-2">
                                        <a href="{{ job.url }}" class="text-decoration-none stretched-link">{{ job.title }}</a>
                                    </h2>

                                    {# Organization #}
                                    {% if job.organization|length %}
                                        <p class="text-muted small mb-2">{{ job.organization.one().title }}</p>
                                    {% endif %}

                                    {# Location #}
                                    {% if job.jobLocation or job.jobCity or job.jobState %}
                                        <p class="text-muted small mb-3">
                                            <i class="bi bi-geo-alt me-1"></i>
                                            {% if job.jobLocation %}
                                                {{ job.jobLocation }}
                                            {% else %}
                                                {{ job.jobCity }}{% if job.jobCity and job.jobState %}, {% endif %}{{ job.jobState }}
                                            {% endif %}
                                        </p>
                                    {% endif %}

                                    {# Meta badges #}
                                    <div class="d-flex flex-wrap gap-1 mb-3">
                                        {% if job.jobCategory|length %}
                                            <span class="badge bg-primary bg-opacity-10 text-primary">{{ job.jobCategory.one().title }}</span>
                                        {% endif %}
                                        {% if job.jobRegion|length %}
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary">{{ job.jobRegion.one().title }}</span>
                                        {% endif %}
                                        {% if job.jobSalaryLow or job.jobSalaryHigh %}
                                            <span class="badge bg-success bg-opacity-10 text-success">
                                                {% if job.jobSalaryLow and job.jobSalaryHigh %}
                                                    ${{ job.jobSalaryLow|number_format }} - ${{ job.jobSalaryHigh|number_format }}K
                                                {% elseif job.jobSalaryLow %}
                                                    From ${{ job.jobSalaryLow|number_format }}K
                                                {% elseif job.jobSalaryHigh %}
                                                    Up to ${{ job.jobSalaryHigh|number_format }}K
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    </div>

                                    {# Summary #}
                                    {% if job.jobOpportunityStatement %}
                                        <p class="text-muted small mb-3 job-summary" style="height: 3.6em; overflow: hidden; line-height: 1.2em;">
                                            {{ job.jobOpportunityStatement|striptags|truncate(140, true, '...') }}
                                        </p>
                                    {% endif %}

                                    {# Posted date #}
                                    <div class="text-muted small">
                                        Posted {{ job.postDate|date('M j, Y') }}
                                    </div>
                                </div>
                            </article>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-search display-1 text-muted"></i>
                    </div>
                    <h2 class="h4 mb-3">No jobs found</h2>
                    <p class="text-muted mb-4">Try adjusting your filters to see more results.</p>
                    {% if currentFilters.region|length or currentFilters.category|length or currentFilters.state %}
                        <a href="{{ craft.app.request.url|split('?')[0] }}" class="btn btn-primary">Clear All Filters</a>
                    {% endif %}
                </div>
            {% endif %}

            {# Pagination using Craft's pageInfo #}
            {% if pageInfo.totalPages > 1 %}
                <nav aria-label="Job listings pagination" class="mt-5">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            Showing {{ pageInfo.first }} to {{ pageInfo.last }} of {{ pageInfo.total }} results
                        </div>
                        <ul class="pagination pagination-sm mb-0">
                            {# Previous page #}
                            {% if pageInfo.prevUrl %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ pageInfo.prevUrl }}">
                                        <i class="bi bi-chevron-left"></i> Previous
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="bi bi-chevron-left"></i> Previous</span>
                                </li>
                            {% endif %}

                            {# Page numbers with smart display #}
                            {% set startPage = pageInfo.currentPage - 2 > 0 ? pageInfo.currentPage - 2 : 1 %}
                            {% set endPage = startPage + 4 <= pageInfo.totalPages ? startPage + 4 : pageInfo.totalPages %}
                            {% if endPage - startPage < 4 and pageInfo.totalPages >= 5 %}
                                {% set startPage = endPage - 4 > 0 ? endPage - 4 : 1 %}
                            {% endif %}

                            {% if startPage > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ pageInfo.getPageUrl(1) }}">1</a>
                                </li>
                                {% if startPage > 2 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endif %}

                            {% for page in startPage..endPage %}
                                {% if page == pageInfo.currentPage %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ pageInfo.getPageUrl(page) }}">{{ page }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if endPage < pageInfo.totalPages %}
                                {% if endPage < pageInfo.totalPages - 1 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ pageInfo.getPageUrl(pageInfo.totalPages) }}">{{ pageInfo.totalPages }}</a>
                                </li>
                            {% endif %}

                            {# Next page #}
                            {% if pageInfo.nextUrl %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ pageInfo.nextUrl }}">
                                        Next <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Next <i class="bi bi-chevron-right"></i></span>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </nav>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current URL without query string
    const baseUrl = window.location.pathname;

    // Function to get current URL parameters
    function getCurrentParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            region: urlParams.get('region') ? urlParams.get('region').split(',') : [],
            category: urlParams.get('category') ? urlParams.get('category').split(',') : [],
            state: urlParams.get('state') ? urlParams.get('state').split(',') : [],
            limit: urlParams.get('limit') || '25',
            page: urlParams.get('page') || '1'
        };
    }

    // Function to build new URL with updated filters
    function buildFilterUrl(filterType, filterValue, action = 'toggle') {
        const params = getCurrentParams();

        if (filterType === 'region' || filterType === 'category' || filterType === 'state') {
            const currentValues = params[filterType];

            if (action === 'toggle') {
                const index = currentValues.indexOf(filterValue.toString());
                if (index > -1) {
                    currentValues.splice(index, 1);
                } else {
                    currentValues.push(filterValue.toString());
                }
            } else if (action === 'remove') {
                const index = currentValues.indexOf(filterValue.toString());
                if (index > -1) {
                    currentValues.splice(index, 1);
                }
            }

            params[filterType] = currentValues;
        }

        // Build URL
        const urlParams = new URLSearchParams();

        // Add region parameters as comma-separated string
        if (params.region.length > 0) {
            urlParams.append('region', params.region.filter(v => v).join(','));
        }

        // Add category parameters as comma-separated string
        if (params.category.length > 0) {
            urlParams.append('category', params.category.filter(v => v).join(','));
        }

        // Add state parameters as comma-separated string
        if (params.state.length > 0) {
            urlParams.append('state', params.state.filter(v => v).join(','));
        }

        // Add limit parameter
        if (params.limit && params.limit !== '25') {
            urlParams.append('limit', params.limit);
        }

        // Reset to page 1 when filters change
        if (filterType !== 'page') {
            urlParams.append('page', '1');
        } else if (params.page && params.page !== '1') {
            urlParams.append('page', params.page);
        }

        const queryString = urlParams.toString();
        return baseUrl + (queryString ? '?' + queryString : '');
    }

    // Handle checkbox changes for regions, categories, and states
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const filterType = this.dataset.filterType;
            const filterValue = this.dataset.filterValue;
            const newUrl = buildFilterUrl(filterType, filterValue, 'toggle');
            window.location.href = newUrl;
        });
    });

    // Handle remove filter buttons
    document.querySelectorAll('.remove-filter').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const filterType = this.dataset.filterType;
            const filterValue = this.dataset.filterValue;

            const newUrl = buildFilterUrl(filterType, filterValue, 'remove');

            window.location.href = newUrl;
        });
    });
});
</script>
{% endblock %}