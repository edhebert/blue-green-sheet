{% extends "_layout.twig" %}

{% block title %}Complete Payment for Job Posting Â· {{ siteName }}{% endblock %}

{% block content %}
  {% requireLogin %}

  {% set currentUser = currentUser %}

  {# Get job ID from URL parameter #}
  {% set jobId = craft.app.request.getParam('jobId') %}

  {# Load the job entry #}
  {% if jobId %}
    {% set jobEntry = craft.entries().section('jobs').id(jobId).status(null).authorId(currentUser.id).one() %}
  {% else %}
    {# If no jobId provided, find the user's most recent unpaid job #}
    {% set jobEntry = craft.entries().section('jobs').status(null).authorId(currentUser.id).paid(false).orderBy('dateCreated DESC').one() %}
  {% endif %}

  <div class="container" style="max-width: 700px;">
    <div class="row">
      <div class="col-12">
        {% if not jobEntry %}
          <!-- Job Not Found -->
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
            </div>
            <h2 class="h4 mb-3">Job Not Found</h2>
            <p class="text-muted mb-4 lead">
              The job posting you're trying to pay for could not be found.
            </p>
            <a href="{{ url('profile') }}" class="btn btn-primary btn-lg">
              <i class="bi bi-arrow-left me-2"></i>Back to Profile
            </a>
          </div>

        {% elseif jobEntry.paid %}
          <!-- Already Paid -->
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            </div>
            <h2 class="h4 mb-3">Payment Already Completed</h2>
            <p class="text-muted mb-4 lead">
              This job posting has already been paid for and is ready to publish.
            </p>
            <a href="{{ url('jobs/edit/' ~ jobEntry.id) }}" class="btn btn-primary btn-lg">
              <i class="bi bi-pencil me-2"></i>Edit Job Posting
            </a>
          </div>

        {% else %}
          <!-- Payment Form -->
          <div class="d-flex align-items-center mb-4">
            <a href="{{ url('jobs/edit/' ~ jobEntry.id) }}" class="btn btn-outline-secondary me-3">
              <i class="bi bi-arrow-left"></i> Back to Edit
            </a>
            <h1 class="h3 mb-0">Complete Payment</h1>
          </div>

          <!-- Job Summary -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Job Summary</h5>
            </div>
            <div class="card-body">
              <h6 class="fw-bold mb-2">{{ jobEntry.title }}</h6>

              {% if jobEntry.jobCategory|length %}
                <div class="text-muted mb-2">
                  <strong>Category:</strong> {{ jobEntry.jobCategory.one().title }}
                </div>
              {% endif %}

              {% if jobEntry.jobLocation or jobEntry.jobCity or jobEntry.jobState %}
                <div class="text-muted mb-2">
                  <strong>Location:</strong>
                  {% if jobEntry.jobLocation %}
                    {{ jobEntry.jobLocation }}
                  {% else %}
                    {{ jobEntry.jobCity }}{% if jobEntry.jobCity and jobEntry.jobState %}, {% endif %}{{ jobEntry.jobState }}
                  {% endif %}
                </div>
              {% endif %}

              {% if currentUser.organization %}
                <div class="text-muted mb-2">
                  <strong>Organization:</strong> {{ currentUser.organization.one().title }}
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Payment Form -->
          <form method="post" id="paymentForm">
            {{ csrfInput() }}
            {{ actionInput('job-posting/activate-job-posting') }}
            {{ hiddenInput('jobId', jobEntry.id) }}
            {{ redirectInput('profile') }}

            <!-- Posting Duration -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Posting Duration</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="duration"
                            id="duration6mo"
                            value="6"
                            checked
                            required
                          >
                          <label class="form-check-label" for="duration6mo">
                            <div class="fw-bold">6 Months</div>
                            <div class="text-muted small">$300</div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="duration"
                            id="duration12mo"
                            value="12"
                            required
                          >
                          <label class="form-check-label" for="duration12mo">
                            <div class="fw-bold">12 Months</div>
                            <div class="text-muted small">$400</div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Payment Method</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="paymentMethod"
                            id="paymentCredit"
                            value="credit"
                            checked
                            required
                          >
                          <label class="form-check-label" for="paymentCredit">
                            <div class="fw-bold">Credit Card</div>
                            <div class="text-muted small">Secure online payment</div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="paymentMethod"
                            id="paymentInvoice"
                            value="invoice"
                            required
                          >
                          <label class="form-check-label" for="paymentInvoice">
                            <div class="fw-bold">Invoice</div>
                            <div class="text-muted small">We will contact you for payment arrangements</div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Order Summary -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Order Summary</h5>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-bold">Job Posting</div>
                    <div class="text-muted small" id="durationText">6 months duration</div>
                  </div>
                  <div class="fw-bold h5 mb-0" id="totalAmount">$300</div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-credit-card me-2"></i>Complete Payment
              </button>
              <a href="{{ url('jobs/edit/' ~ jobEntry.id) }}" class="btn btn-outline-secondary">
                Cancel
              </a>
            </div>
          </form>

        {% endif %}
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Update pricing based on duration selection
    const duration6mo = document.getElementById('duration6mo');
    const duration12mo = document.getElementById('duration12mo');
    const durationText = document.getElementById('durationText');
    const totalAmount = document.getElementById('totalAmount');

    function updatePricing() {
      if (duration6mo && duration6mo.checked) {
        durationText.textContent = '6 months duration';
        totalAmount.textContent = '$300';
      } else if (duration12mo && duration12mo.checked) {
        durationText.textContent = '12 months duration';
        totalAmount.textContent = '$400';
      }
    }

    if (duration6mo) {
      duration6mo.addEventListener('change', updatePricing);
    }
    if (duration12mo) {
      duration12mo.addEventListener('change', updatePricing);
    }

    // Initialize pricing
    updatePricing();

    // Debug form submission
    const form = document.getElementById('paymentForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        console.log('Form submitting...');
        const formData = new FormData(form);
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}: ${value}`);
        }
      });
    }
  });
  </script>

{% endblock %}