{% extends "_layout.twig" %}

{% block title %}Edit Job Posting Â· {{ siteName }}{% endblock %}

{% block content %}
  {# Get and validate the job entry from URL parameter #}
  {% set entryId = craft.app.request.getSegment(3) %}

  {# Ensure we have a valid entry ID #}
  {% if not entryId or not entryId|number_format %}
    {% set jobEntry = null %}
  {% else %}
    {# Only load entries that belong to current user (unless admin) #}
    {% if currentUser.admin %}
      {% set jobEntry = craft.entries().section('jobs').id(entryId).status(null).one() %}
    {% else %}
      {% set jobEntry = craft.entries().section('jobs').id(entryId).status(null).authorId(currentUser.id).one() %}
    {% endif %}
  {% endif %}
  {% set currentUser = currentUser %}

  {# Check if current user is a recruiter #}
  {% set userOrg = currentUser.organization.one() %}
  {% set isRecruiter = userOrg and userOrg.organizationType == 'recruiter' %}

  {# Check if we just created a new school #}
  {% set newSchoolId = craft.app.request.getParam('newSchoolId') %}
  {% set newlyCreatedSchool = newSchoolId ? craft.entries().id(newSchoolId).one() : null %}

  {# Get all schools (organizations with type 'school') for recruiter dropdown #}
  {% set schools = craft.entries().section('organizations').organizationType('school').orderBy('title asc').all() %}

  {# Get section/type IDs for creating new organizations #}
  {% set orgSample = craft.entries().section('organizations').one() %}
  {% set orgSectionId = orgSample ? orgSample.sectionId : null %}
  {% set orgEntryTypeId = orgSample ? orgSample.typeId : null %}

  {# Get options for new school form #}
  {% set countryOptions = craft.projectTools.options('country') %}
  {% set stateOptions = craft.projectTools.options('state') %}

  <div class="container" style="max-width: 800px;">
    <div class="row">
      <div class="col-12">
        {% if not currentUser %}
          <!-- Account Required Message -->
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-person-circle text-primary" style="font-size: 4rem;"></i>
            </div>
            <h2 class="h4 mb-3">Account Required</h2>
            <p class="text-muted mb-4 lead">
              You need to be logged in to edit job postings.
            </p>
            <a href="{{ url('login') }}" class="button button-xlarge rounded-pill px-4">
              <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
            </a>
          </div>

        {% elseif not currentUser.isInGroup('jobPosters') and not currentUser.admin %}
          <!-- Permission Required Message -->
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-shield-exclamation text-warning" style="font-size: 4rem;"></i>
            </div>
            <h2 class="h4 mb-3">Access Restricted</h2>
            <p class="text-muted mb-4 lead">
              Your account doesn't have permission to edit jobs.
            </p>
            <a href="{{ url('contact') }}" class="button button-xlarge button-rounded px-4">
              <i class="bi bi-envelope me-2"></i>Contact Us
            </a>
          </div>

        {% elseif not jobEntry %}
          <!-- Job Not Found -->
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
            </div>
            <h2 class="h4 mb-3">Job Not Found</h2>
            <p class="text-muted mb-4 lead">
              The job posting you're trying to edit could not be found.
            </p>
            <a href="{{ url('profile') }}" class="button button-xlarge rounded-pill px-4">
              <i class="bi bi-arrow-left me-2"></i>Back to Profile
            </a>
          </div>

        {% elseif not jobEntry or (jobEntry.authorId != currentUser.id and not currentUser.admin) %}
          <!-- Job Not Found or Not Owner -->
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-shield-exclamation text-danger" style="font-size: 4rem;"></i>
            </div>
            <h2 class="h4 mb-3">Access Denied</h2>
            <p class="text-muted mb-4 lead">
              {% if not jobEntry %}
                The job posting you're trying to edit could not be found or you don't have permission to access it.
              {% else %}
                You can only edit your own job postings.
              {% endif %}
            </p>
            <a href="{{ url('profile') }}" class="button button-xlarge rounded-pill px-4">
              <i class="bi bi-arrow-left me-2"></i>Back to Profile
            </a>
          </div>

        {% else %}
          <!-- Authorized User - Show Job Editing Form -->

        {# Check if user's organization has required location data #}
        {% set skipJobForm = false %}
        {% if userOrg %}
          {% set hasLocation = false %}
          {% if userOrg.country == 'unitedStates' %}
            {% set hasLocation = userOrg.orgCity and userOrg.orgState %}
          {% elseif userOrg.country == 'international' %}
            {% set hasLocation = userOrg.orgLocation %}
          {% endif %}

          {% if not hasLocation %}
            <!-- Organization Missing Location Data -->
            <div class="alert alert-warning">
              <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Location Information Required</h4>
              <p>Your organization is missing required location information. Please update your organization profile before editing jobs.</p>
              <a href="{{ url('profile/edit-organization') }}" class="btn btn-primary">
                <i class="bi bi-pencil me-2"></i>Edit My Organization
              </a>
              <a href="{{ url('profile') }}" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-arrow-left me-2"></i>Back to Profile
              </a>
            </div>
            {% set skipJobForm = true %}
          {% endif %}
        {% endif %}

        {% if not skipJobForm %}
        {% if jobEntry and jobEntry.getErrors() %}
          <div class="alert alert-danger">
            <strong>We couldn't save your job posting.</strong>
            <ul class="mb-0">
              {% for attr, errs in jobEntry.getErrors() %}
                {% for err in errs %}
                  <li>{{ err }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="d-flex align-items-center mb-4">
          <a href="{{ url('profile') }}" class="button button-small button-border rounded-pill me-3">
            <i class="bi bi-arrow-left"></i> Back to Profile
          </a>
          <h1 class="h3 mb-0">Edit Job Posting</h1>
        </div>

        <form method="post" class="" enctype="multipart/form-data" novalidate>
          {{ csrfInput() }}
          {{ actionInput('entries/save-entry') }}
          {{ hiddenInput('entryId', jobEntry.id) }}
          {{ hiddenInput('sectionId', jobEntry.sectionId) }}
          {{ hiddenInput('typeId', jobEntry.typeId) }}
          {# Auto-populate listingOrganization field with current user's organization (if not already set) #}
          {% if userOrg and not jobEntry.listingOrganization.one() %}
            {{ hiddenInput('fields[listingOrganization][]', userOrg.id) }}
          {% endif %}
          {# Current entry status - will be updated by form #}
          {{ redirectInput('profile?updated=job') }}

          <!-- Job Title -->
          <div class="mb-4">
            <label for="title" class="form-label fw-bold">Job Title <span class="text-danger">*</span></label>
            <input
              type="text"
              id="title"
              name="title"
              class="form-control{% if jobEntry and jobEntry.getErrors('title') %} is-invalid{% endif %}"
              value="{{ (jobEntry ? jobEntry.title : '')|e }}"
              placeholder="e.g., Head of School, Business Manager, Development Director"
            >
            {% if jobEntry and jobEntry.getErrors('title') %}
              <div class="invalid-feedback">
                {{ jobEntry.getErrors('title')|join(', ') }}
              </div>
            {% endif %}
          </div>

          <!-- School Selection (Recruiters Only) -->
          {% if isRecruiter %}
            <div class="mb-4">
              <label for="schoolSelect" class="form-label fw-bold">School/Organization <span class="text-danger">*</span></label>
              <select
                id="schoolSelect"
                name="fields[school][]"
                class="form-select{% if jobEntry and jobEntry.getErrors('school') %} is-invalid{% endif %}"
              >
                <option value="">Select the school for this position...</option>
                {% for school in schools %}
                  {% set isSelected = false %}
                  {% if jobEntry and jobEntry.school %}
                    {% for selectedSchool in jobEntry.school.all() %}
                      {% if selectedSchool.id == school.id %}
                        {% set isSelected = true %}
                      {% endif %}
                    {% endfor %}
                  {% elseif newlyCreatedSchool and newlyCreatedSchool.id == school.id %}
                    {# Pre-select the newly created school #}
                    {% set isSelected = true %}
                  {% endif %}
                  <option value="{{ school.id }}"
                          data-country="{{ school.country }}"
                          data-city="{{ school.orgCity }}"
                          data-state="{{ school.orgState }}"
                          data-location="{{ school.orgLocation }}"
                          {% if isSelected %}selected{% endif %}>
                    {{ school.title }}
                    {% if school.orgCity and school.orgState %}
                      ({{ school.orgCity }}, {{ school.orgState }})
                    {% elseif school.orgLocation %}
                      ({{ school.orgLocation }})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
              {% if jobEntry and jobEntry.getErrors('school') %}
                <div class="invalid-feedback">
                  {{ jobEntry.getErrors('school')|join(', ') }}
                </div>
              {% endif %}

              <!-- Add New School Link -->
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="collapse" data-bs-target="#addSchoolCollapse"
                        aria-expanded="false" aria-controls="addSchoolCollapse">
                  <i class="bi bi-plus-circle me-1"></i>School not listed? Click here to add one
                </button>
              </div>

              <!-- Inline Add New School Form (Collapsed) -->
              <div id="addSchoolCollapse" class="collapse mt-3">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-building me-2"></i>Add New School</h6>
                  </div>
                  <div class="card-body bg-light">
                    {% if not orgSectionId or not orgEntryTypeId %}
                      <div class="alert alert-warning mb-0">Unable to add new school at this time. Please contact support.</div>
                    {% else %}
                      <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle me-1"></i>Fill out the school information below. Your job posting will be saved and you can continue afterward.
                      </p>

                      <div id="newSchoolFields">
                        <div class="mb-3">
                          <label for="newSchoolName" class="form-label">School Name <span class="text-danger">*</span></label>
                          <input type="text" id="newSchoolName" class="form-control" placeholder="Enter school name">
                        </div>

                        <div class="mb-3">
                          <label for="newSchoolWebsite" class="form-label">Website</label>
                          <input type="text" id="newSchoolWebsite" class="form-control" placeholder="example.com or https://example.com">
                        </div>

                        <div class="mb-3">
                          <label for="newSchoolCountry" class="form-label">Country <span class="text-danger">*</span></label>
                          <select id="newSchoolCountry" class="form-select">
                            <option value="">â Select â</option>
                            {% for opt in countryOptions %}
                              <option value="{{ opt.value }}">{{ opt.label }}</option>
                            {% endfor %}
                          </select>
                        </div>

                        <!-- US Fields -->
                        <div id="newSchoolUSFields" style="display:none;">
                          <div class="row g-3">
                            <div class="col-md-6">
                              <label for="newSchoolCity" class="form-label">City <span class="text-danger">*</span></label>
                              <input type="text" id="newSchoolCity" class="form-control">
                            </div>
                            <div class="col-md-6">
                              <label for="newSchoolState" class="form-label">State <span class="text-danger">*</span></label>
                              <select id="newSchoolState" class="form-select">
                                <option value="">â Select â</option>
                                {% for opt in stateOptions %}
                                  <option value="{{ opt.value }}">{{ opt.label }}</option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
                        </div>

                        <!-- International Fields -->
                        <div id="newSchoolIntlFields" style="display:none;">
                          <div class="mb-3">
                            <label for="newSchoolLocation" class="form-label">Location (City / Country) <span class="text-danger">*</span></label>
                            <input type="text" id="newSchoolLocation" class="form-control" placeholder="London, United Kingdom">
                          </div>
                        </div>

                        <!-- Logo Upload -->
                        <div class="mb-3">
                          <label for="newSchoolLogo" class="form-label">Logo</label>
                          <input type="file" id="newSchoolLogo" class="form-control" accept="image/*">
                          <div class="form-text">Upload your school's logo (optional)</div>
                        </div>

                        <div class="d-grid gap-2 d-sm-flex mt-3">
                          <button type="button" class="btn btn-primary" id="saveNewSchoolBtn">
                            <i class="bi bi-check-circle me-1"></i>Save School & Continue
                          </button>
                          <button type="button" class="btn btn-outline-secondary"
                                  data-bs-toggle="collapse" data-bs-target="#addSchoolCollapse">
                            Cancel
                          </button>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Job Category -->
          <div class="mb-4">
            <label for="jobCategory" class="form-label fw-bold">Job Category <span class="text-danger">*</span></label>
            <select
              id="jobCategory"
              name="fields[jobCategory][]"
              class="form-select{% if jobEntry and jobEntry.getErrors('jobCategory') %} is-invalid{% endif %}"
            >
              <option value="">Select a category...</option>
              {% for category in craft.categories().group('jobCategories').all() %}
                {% set isSelected = false %}
                {% if jobEntry and jobEntry.jobCategory %}
                  {% for selectedCategory in jobEntry.jobCategory.all() %}
                    {% if selectedCategory.id == category.id %}
                      {% set isSelected = true %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                <option value="{{ category.id }}" {% if isSelected %}selected{% endif %}>
                  {{ category.title }}
                </option>
              {% endfor %}
            </select>
            {% if jobEntry and jobEntry.getErrors('jobCategory') %}
              <div class="invalid-feedback">
                {{ jobEntry.getErrors('jobCategory')|join(', ') }}
              </div>
            {% endif %}
          </div>

          <!-- Job Description (Rich Text) -->
          <div class="mb-4">
            <label for="jobDescription" class="form-label fw-bold">Job Description <span class="text-danger">*</span></label>
            <div id="jobDescription-editor" style="min-height: 300px; border: 1px solid #ced4da; border-radius: 0.375rem;"></div>
            <textarea
              id="jobDescription"
              name="fields[jobDescription]"
              class="d-none{% if jobEntry and jobEntry.getErrors('jobDescription') %} is-invalid{% endif %}"
              required
            >{{ jobEntry ? jobEntry.jobDescription : '' }}</textarea>
            {% if jobEntry and jobEntry.getErrors('jobDescription') %}
              <div class="invalid-feedback">
                {{ jobEntry.getErrors('jobDescription')|join(', ') }}
              </div>
            {% endif %}
          </div>

          <!-- Opportunity Statement (Rich Text) -->
          <div class="mb-4">
            <label for="jobOpportunityStatement" class="form-label fw-bold">Opportunity Statement</label>
            <div class="form-text mb-2">Include your Opportunity Statement of a link to your Opportunity Statement.<br>If you wish to include a file, you may do so below.</div>
            <div id="jobOpportunityStatement-editor" style="min-height: 200px; border: 1px solid #ced4da; border-radius: 0.375rem;"></div>
            <textarea
              id="jobOpportunityStatement"
              name="fields[jobOpportunityStatement]"
              class="d-none"
            >{{ jobEntry ? jobEntry.jobOpportunityStatement : '' }}</textarea>
          </div>

          <!-- Salary Range -->
          <div class="row mb-4">
            <div class="col-md-6">
              <label for="jobSalaryLow" class="form-label fw-bold">Salary Range - Low</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input
                  type="number"
                  id="jobSalaryLow"
                  name="fields[jobSalaryLow]"
                  class="form-control"
                  value="{{ jobEntry ? jobEntry.jobSalaryLow : '' }}"
                  min="0"
                  step="1000"
                >
              </div>
            </div>
            <div class="col-md-6">
              <label for="jobSalaryHigh" class="form-label fw-bold">Salary Range - High</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input
                  type="number"
                  id="jobSalaryHigh"
                  name="fields[jobSalaryHigh]"
                  class="form-control"
                  value="{{ jobEntry ? jobEntry.jobSalaryHigh : '' }}"
                  min="0"
                  step="1000"
                >
              </div>
            </div>
          </div>

          <!-- Hidden Location Fields (Auto-populated from school/organization) -->
          <input type="hidden" id="hiddenCountry" name="fields[country]" value="{{ jobEntry ? jobEntry.country : '' }}">
          <input type="hidden" id="hiddenJobCity" name="fields[jobCity]" value="{{ jobEntry ? jobEntry.jobCity : '' }}">
          <input type="hidden" id="hiddenJobState" name="fields[jobState]" value="{{ jobEntry ? jobEntry.jobState : '' }}">
          <input type="hidden" id="hiddenJobLocation" name="fields[jobLocation]" value="{{ jobEntry ? jobEntry.jobLocation : '' }}">

          <!-- Application Instructions -->
          <div class="mb-4">
            <label for="jobApplicationInstructions" class="form-label fw-bold">Application Instructions <span class="text-danger">*</span></label>
            <textarea
              id="jobApplicationInstructions"
              name="fields[jobApplicationInstructions]"
              class="form-control{% if jobEntry and jobEntry.getErrors('jobApplicationInstructions') %} is-invalid{% endif %}"
              rows="4"
              placeholder="How should candidates apply? Include contact information, required documents, application deadlines, etc."
              required
            >{{ jobEntry ? jobEntry.jobApplicationInstructions : '' }}</textarea>
            {% if jobEntry and jobEntry.getErrors('jobApplicationInstructions') %}
              <div class="invalid-feedback">
                {{ jobEntry.getErrors('jobApplicationInstructions')|join(', ') }}
              </div>
            {% endif %}
          </div>

          <!-- Job Attachments -->
          <div class="mb-4">
            <label class="form-label fw-bold">Job Attachments <span class="text-muted">(Optional)</span></label>
            <p class="form-text text-muted mb-2">Upload up to 3 documents (PDF or Word format, max 10MB each)</p>

            <div id="attachmentsList" class="mb-3">
              <!-- Existing attachments will be displayed here -->
              {% if jobEntry and jobEntry.jobAttachments %}
                {% for attachment in jobEntry.jobAttachments.all() %}
                  <div class="attachment-item d-flex align-items-center mb-2 p-2 border rounded" data-asset-id="{{ attachment.id }}">
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <span class="me-auto">{{ attachment.filename }}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-attachment" onclick="removeAttachment(this)">
                      <i class="fas fa-times"></i>
                    </button>
                    <input type="hidden" name="fields[jobAttachments][]" value="{{ attachment.id }}">
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <div class="upload-area border-2 border-dashed rounded p-4 text-center" id="uploadArea" style="border-color: #dee2e6;">
              <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
              <p class="mb-2">Drop files here or <button type="button" class="btn btn-link p-0" id="browseFiles">browse</button></p>
              <small class="text-muted">Accepted formats: PDF, DOC, DOCX | Maximum: 3 files, 10MB each</small>
              <input
                type="file"
                id="jobAttachments"
                name="attachmentFiles[]"
                class="d-none"
                multiple
                accept=".pdf,.doc,.docx"
              >
            </div>

            {% if jobEntry and jobEntry.getErrors('jobAttachments') %}
              <div class="invalid-feedback d-block">
                {{ jobEntry.getErrors('jobAttachments')|join(', ') }}
              </div>
            {% endif %}
          </div>

          <!-- Job Status -->
          <div class="mb-4">
            <h5 class="fw-bold mb-3">Job Status</h5>
            {% if jobEntry.status == 'live' and jobEntry.enabled %}
              <div class="alert alert-info">
                <strong>Published:</strong> This job posting is currently live and visible to candidates.
              </div>
            {% else %}
              <div class="alert alert-warning">
                <strong>Draft:</strong> This job posting is currently not visible to candidates.
              </div>
            {% endif %}

            {% if jobEntry.paid %}
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="jobEnabled" name="enabled" value="1" {% if jobEntry.status == 'live' and jobEntry.enabled %}checked{% endif %}>
                <label class="form-check-label" for="jobEnabled">
                  <strong>Publish and make visible to candidates</strong>
                  <div class="form-text">Check to publish this job posting</div>
                </label>
              </div>
            {% endif %}
          </div>

          <!-- Validation Alert Area -->
          <div id="validationAlert" class="alert alert-danger d-none mb-4">
            <h6 class="alert-heading mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Required Fields Missing</h6>
            <p class="mb-2">Please complete the following required fields before continuing to payment:</p>
            <ul id="missingFieldsList" class="mb-0"></ul>
          </div>

          <div class="d-grid gap-2">
            {% if not jobEntry.paid %}
              {# For unpaid/incomplete jobs, show option to complete and pay #}
              <button type="button" class="btn btn-primary btn-lg" id="saveChanges">
                <i class="bi bi-check-circle me-2"></i>Save Changes
              </button>

              {# Add visual spacing before payment section #}
              <div class="d-grid" style="margin: 2rem 0; border-top: 2px solid #e0e0e0; padding-top: 2rem;">
                <div class="alert alert-success mb-3">
                  <i class="bi bi-info-circle me-2"></i>
                  Please complete payment to finish your transaction.
                </div>
                <button type="button" class="btn btn-success btn-lg" id="completeAndPay">
                  <i class="bi bi-credit-card me-2"></i>Complete & Continue to Payment
                </button>
              </div>
            {% else %}
              {# For paid jobs, just allow editing #}
              <button type="button" class="btn btn-primary btn-lg" id="saveChangesPaid">
                <i class="bi bi-check-circle me-2"></i>Save Changes
              </button>
            {% endif %}
            <a href="{{ url('profile') }}" class="btn btn-outline-secondary">
              Cancel
            </a>
          </div>
        </form>

  {% if currentUser and (currentUser.isInGroup('jobPosters') or currentUser.admin) %}
  <!-- CKEditor CDN -->
  <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>

  <!-- CKEditor Height Styling -->
  <style>
    .ck-editor__editable {
      min-height: 300px !important;
    }
    #jobOpportunityStatement-editor .ck-editor__editable {
      min-height: 200px !important;
    }
  </style>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize CKEditor for rich text fields FIRST
    let jobDescriptionEditor, opportunityStatementEditor;

    ClassicEditor
      .create(document.querySelector('#jobDescription-editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'outdent', 'indent', '|', 'undo', 'redo']
      })
      .then(editor => {
        jobDescriptionEditor = editor;
        // Sync with hidden textarea
        editor.model.document.on('change:data', () => {
          document.querySelector('#jobDescription').value = editor.getData();
        });
        // Load existing content
        const existingContent = document.querySelector('#jobDescription').value;
        if (existingContent) {
          editor.setData(existingContent);
        }
      })
      .catch(error => {
        console.error('CKEditor initialization failed:', error);
      });

    ClassicEditor
      .create(document.querySelector('#jobOpportunityStatement-editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'outdent', 'indent', '|', 'undo', 'redo']
      })
      .then(editor => {
        opportunityStatementEditor = editor;
        // Sync with hidden textarea
        editor.model.document.on('change:data', () => {
          document.querySelector('#jobOpportunityStatement').value = editor.getData();
        });
        // Load existing content
        const existingContent = document.querySelector('#jobOpportunityStatement').value;
        if (existingContent) {
          editor.setData(existingContent);
        }
      })
      .catch(error => {
        console.error('CKEditor initialization failed:', error);
      });

    // Auto-populate location fields from school selection (for recruiters)
    const schoolSelect = document.getElementById('schoolSelect');
    if (schoolSelect) {
      schoolSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];

        if (!selectedOption || !selectedOption.value) {
          return; // No school selected
        }

        // Get location data from data attributes
        const schoolCountry = selectedOption.dataset.country;
        const schoolCity = selectedOption.dataset.city;
        const schoolState = selectedOption.dataset.state;
        const schoolLocation = selectedOption.dataset.location;

        // Validate school has location data
        const hasLocation = (schoolCountry === 'unitedStates' && schoolCity && schoolState) ||
                           (schoolCountry === 'international' && schoolLocation);

        if (!hasLocation) {
          alert('â ï¸ This school is missing location information.\n\nPlease contact support@bluegreensheet.com to have it updated.');
          this.value = ''; // Clear selection
          return;
        }

        // Populate hidden location fields
        document.getElementById('hiddenCountry').value = schoolCountry || '';
        document.getElementById('hiddenJobCity').value = schoolCity || '';
        document.getElementById('hiddenJobState').value = schoolState || '';
        document.getElementById('hiddenJobLocation').value = schoolLocation || '';
      });
    }

    // File upload functionality
    const jobAttachmentsInput = document.getElementById('jobAttachments');
    const browseFilesBtn = document.getElementById('browseFiles');
    const uploadArea = document.getElementById('uploadArea');
    const attachmentsList = document.getElementById('attachmentsList');
    const maxFiles = 3;
    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
    let currentAttachments = [];

    // Initialize current attachments count
    const existingAttachments = attachmentsList.querySelectorAll('.attachment-item');
    currentAttachments = Array.from(existingAttachments);

    if (jobAttachmentsInput && browseFilesBtn && uploadArea) {
      // Browse files button click
      browseFilesBtn.addEventListener('click', function(e) {
        e.preventDefault();
        jobAttachmentsInput.click();
      });

      // File input change
      jobAttachmentsInput.addEventListener('change', function(e) {
        handleFileSelection(e.target.files);
      });

      // Drag and drop functionality
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#0d6efd';
        uploadArea.style.backgroundColor = '#f8f9fa';
      });

      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#dee2e6';
        uploadArea.style.backgroundColor = '';
      });

      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#dee2e6';
        uploadArea.style.backgroundColor = '';
        handleFileSelection(e.dataTransfer.files);
      });
    }

    function handleFileSelection(files) {
      // Check total file count
      if (currentAttachments.length + files.length > maxFiles) {
        alert(`You can only upload up to ${maxFiles} files total. You currently have ${currentAttachments.length} file(s).`);
        return;
      }

      // Process each file
      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Check file size
        if (file.size > maxSize) {
          alert(`File "${file.name}" is too large. Maximum file size is 10MB.`);
          continue;
        }

        // Check file type
        if (!file.name.match(/\.(pdf|doc|docx)$/i)) {
          alert(`File "${file.name}" is not a supported format. Please upload PDF, DOC, or DOCX files.`);
          continue;
        }

        // Add file to the list
        addAttachmentToList(file);
      }

      // Clear the input
      jobAttachmentsInput.value = '';
    }

    function addAttachmentToList(file) {
      const attachmentDiv = document.createElement('div');
      attachmentDiv.className = 'attachment-item d-flex align-items-center mb-2 p-2 border rounded';

      const fileIcon = getFileIcon(file.name);
      const fileSize = formatFileSize(file.size);

      attachmentDiv.innerHTML = `
        <i class="${fileIcon} me-2"></i>
        <div class="me-auto">
          <span>${file.name}</span>
          <small class="text-muted d-block">${fileSize}</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger remove-attachment" onclick="removeAttachment(this)">
          <i class="fas fa-times"></i>
        </button>
      `;

      // Create a hidden input for the file
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.name = 'fields[jobAttachments][]';
      fileInput.className = 'd-none';
      fileInput.files = createFileList([file]);
      attachmentDiv.appendChild(fileInput);

      attachmentsList.appendChild(attachmentDiv);
      currentAttachments.push(attachmentDiv);
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      switch(ext) {
        case 'pdf': return 'fas fa-file-pdf text-danger';
        case 'doc':
        case 'docx': return 'fas fa-file-word text-primary';
        default: return 'fas fa-file text-secondary';
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function createFileList(files) {
      const dt = new DataTransfer();
      files.forEach(file => dt.items.add(file));
      return dt.files;
    }

    // Global function for removing attachments
    window.removeAttachment = function(button) {
      const attachmentItem = button.closest('.attachment-item');
      const index = currentAttachments.indexOf(attachmentItem);
      if (index > -1) {
        currentAttachments.splice(index, 1);
      }
      attachmentItem.remove();
    };

    // Auto-populate location for school users on page load
    {% if not isRecruiter and userOrg %}
      document.getElementById('hiddenCountry').value = '{{ userOrg.country }}';
      document.getElementById('hiddenJobCity').value = '{{ userOrg.orgCity }}';
      document.getElementById('hiddenJobState').value = '{{ userOrg.orgState }}';
      document.getElementById('hiddenJobLocation').value = '{{ userOrg.orgLocation }}';
    {% endif %}

    // Save Changes button handlers
    function handleSaveChanges() {
      console.log('Save changes clicked');

      // Ensure CKEditor content is synced before submission
      if (jobDescriptionEditor) {
        document.querySelector('#jobDescription').value = jobDescriptionEditor.getData();
      }
      if (opportunityStatementEditor) {
        document.querySelector('#jobOpportunityStatement').value = opportunityStatementEditor.getData();
      }

      // Force remove all Bootstrap validation classes and states
      const form = document.querySelector('form');
      form.classList.remove('was-validated');
      form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
      });

      // Create form data manually to bypass any form validation
      const formData = new FormData();

      // Add essential form fields
      formData.append('CRAFT_CSRF_TOKEN', document.querySelector('input[name="CRAFT_CSRF_TOKEN"]').value);
      formData.append('action', 'entries/save-entry');
      formData.append('entryId', document.querySelector('input[name="entryId"]').value);
      formData.append('sectionId', document.querySelector('input[name="sectionId"]').value);

      // Handle enabled/paid status based on current job state
      const isPaid = {{ jobEntry.paid ? 'true' : 'false' }};

      if (isPaid) {
        // For paid jobs, preserve existing enabled status
        const currentEnabled = document.querySelector('input[name="enabled"]');
        if (currentEnabled && currentEnabled.checked) {
          formData.append('enabled', '1');
        } else {
          formData.append('enabled', '0');
        }
        formData.append('fields[paid]', '1'); // Keep paid status
      } else {
        // For unpaid jobs, always keep disabled until payment
        formData.append('enabled', '0');
        formData.append('fields[paid]', '0');
      }

      formData.append('redirect', '{{ url("profile") }}');

      // Add job data fields (only if they have values)
      const title = document.getElementById('title').value;
      if (title) formData.append('title', title);

      // Add school selection (for recruiters)
      const schoolSelect = document.getElementById('schoolSelect');
      if (schoolSelect && schoolSelect.value) {
        formData.append('fields[school][]', schoolSelect.value);
      }

      const category = document.querySelector('select[name="fields[jobCategory][]"]').value;
      if (category) formData.append('fields[jobCategory][]', category);

      const description = document.getElementById('jobDescription').value;
      if (description) formData.append('fields[jobDescription]', description);

      const opportunityStatement = document.getElementById('jobOpportunityStatement').value;
      if (opportunityStatement) formData.append('fields[jobOpportunityStatement]', opportunityStatement);

      const salaryLow = document.getElementById('jobSalaryLow').value;
      if (salaryLow) formData.append('fields[jobSalaryLow]', salaryLow);

      const salaryHigh = document.getElementById('jobSalaryHigh').value;
      if (salaryHigh) formData.append('fields[jobSalaryHigh]', salaryHigh);

      const countryValue = document.getElementById('hiddenCountry').value;
      if (countryValue) formData.append('fields[country]', countryValue);

      const cityValue = document.getElementById('hiddenJobCity').value;
      if (cityValue) formData.append('fields[jobCity]', cityValue);

      const stateValue = document.getElementById('hiddenJobState').value;
      if (stateValue) formData.append('fields[jobState]', stateValue);

      const locationValue = document.getElementById('hiddenJobLocation').value;
      if (locationValue) formData.append('fields[jobLocation]', locationValue);

      const applicationInstructions = document.getElementById('jobApplicationInstructions').value;
      if (applicationInstructions) formData.append('fields[jobApplicationInstructions]', applicationInstructions);

      // Add listingOrganization (from hidden field)
      const listingOrgField = document.querySelector('input[name="fields[listingOrganization][]"]');
      if (listingOrgField && listingOrgField.value) {
        formData.append('fields[listingOrganization][]', listingOrgField.value);
      }

      console.log('About to submit edit form data via fetch');
      console.log('Form data entries:', Array.from(formData.entries()));

      // Submit via fetch to avoid browser form validation issues
      fetch(form.action, {
        method: 'POST',
        body: formData
      }).then(response => {
        console.log('Fetch response received:', response);
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          window.location.href = '{{ url("profile") }}';
        }
      }).catch(error => {
        console.error('Fetch error:', error);
        window.location.href = '{{ url("profile") }}';
      });
    }

    // Attach handlers to both save buttons
    const saveChangesBtn = document.getElementById('saveChanges');
    if (saveChangesBtn) {
      saveChangesBtn.addEventListener('click', handleSaveChanges);
    }

    const saveChangesPaidBtn = document.getElementById('saveChangesPaid');
    if (saveChangesPaidBtn) {
      saveChangesPaidBtn.addEventListener('click', handleSaveChanges);
    }

    // Complete & Continue to Payment button handler with validation
    const completeAndPayBtn = document.getElementById('completeAndPay');
    if (completeAndPayBtn) {
      completeAndPayBtn.addEventListener('click', function() {
        console.log('Complete and pay clicked');

        // Ensure CKEditor content is synced before validation
        if (jobDescriptionEditor) {
          document.querySelector('#jobDescription').value = jobDescriptionEditor.getData();
        }
        if (opportunityStatementEditor) {
          document.querySelector('#jobOpportunityStatement').value = opportunityStatementEditor.getData();
        }

        // Enable Bootstrap validation for this submission
        const form = document.querySelector('form');
        form.classList.add('was-validated');

        // Collect validation errors
        const missingFields = [];

        // Check Job Description (CKEditor)
        const jobDescriptionContent = document.querySelector('#jobDescription').value;
        const jobDescriptionEditorEl = document.querySelector('#jobDescription-editor');
        const jobDescriptionContainer = jobDescriptionEditorEl.closest('.mb-4');

        if (!jobDescriptionContent || jobDescriptionContent.trim() === '' || jobDescriptionContent === '<p><br></p>') {
          missingFields.push({
            name: 'Job Description',
            element: jobDescriptionEditorEl,
            container: jobDescriptionContainer
          });
          // Add validation styling to CKEditor
          jobDescriptionEditorEl.style.borderColor = '#dc3545';
        } else {
          // Remove error styling if content is valid
          jobDescriptionEditorEl.style.borderColor = '#ced4da';
          const errorDiv = jobDescriptionContainer.querySelector('.invalid-feedback');
          if (errorDiv) {
            errorDiv.style.display = 'none';
          }
        }

        // Check other required fields
        const requiredFields = [
          { selector: '#title', name: 'Job Title' },
          { selector: 'select[name="fields[jobCategory][]"]', name: 'Job Category' },
          { selector: '#jobApplicationInstructions', name: 'Application Instructions' },
        ];

        // Check each required field
        requiredFields.forEach(field => {
          const element = document.querySelector(field.selector);
          if (element && (!element.value || element.value.trim() === '')) {
            missingFields.push({
              name: field.name,
              element: element,
              container: element.closest('.mb-4') || element.closest('.mb-3')
            });
          }
        });

        // Validate location data from hidden fields
        const hiddenCountry = document.getElementById('hiddenCountry').value;
        if (!hiddenCountry) {
          missingFields.push({
            name: 'Location Information',
            element: null,
            container: null
          });
        } else if (hiddenCountry === 'unitedStates') {
          const hiddenCity = document.getElementById('hiddenJobCity').value;
          const hiddenState = document.getElementById('hiddenJobState').value;
          if (!hiddenCity || !hiddenState) {
            missingFields.push({
              name: 'School Location (City/State)',
              element: null,
              container: null
            });
          }
        } else if (hiddenCountry === 'international') {
          const hiddenLocation = document.getElementById('hiddenJobLocation').value;
          if (!hiddenLocation) {
            missingFields.push({
              name: 'School Location',
              element: null,
              container: null
            });
          }
        }

        // If there are missing fields, show the alert and stop
        if (missingFields.length > 0) {
          console.log('Validation failed - missing fields:', missingFields.map(f => f.name));

          // Populate the missing fields list
          const missingFieldsList = document.getElementById('missingFieldsList');
          const validationAlert = document.getElementById('validationAlert');

          missingFieldsList.innerHTML = '';
          missingFields.forEach(field => {
            const li = document.createElement('li');
            li.textContent = field.name;
            missingFieldsList.appendChild(li);
          });

          // Show the alert
          validationAlert.classList.remove('d-none');

          // Scroll to the alert so user sees the message
          validationAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });

          return;
        }

        // Hide validation alert if everything is valid
        document.getElementById('validationAlert').classList.add('d-none');

        console.log('Form validation passed, saving and redirecting to payment');

        // Create form data for submission
        const formData = new FormData();

        // Add essential form fields
        formData.append('CRAFT_CSRF_TOKEN', document.querySelector('input[name="CRAFT_CSRF_TOKEN"]').value);
        formData.append('action', 'entries/save-entry');
        formData.append('entryId', document.querySelector('input[name="entryId"]').value);
        formData.append('sectionId', document.querySelector('input[name="sectionId"]').value);

        // Keep entry disabled until actual payment
        formData.append('enabled', '0');
        formData.append('fields[paid]', '0');

        // Set redirect to payment page
        formData.append('redirect', '{{ url("jobs/payment") }}?jobId={{ jobEntry.id }}');

        // Add all required form data
        const title = document.getElementById('title').value;
        if (title) formData.append('title', title);

        // Add school selection (for recruiters)
        const schoolSelect = document.getElementById('schoolSelect');
        if (schoolSelect && schoolSelect.value) {
          formData.append('fields[school][]', schoolSelect.value);
        }

        const category = document.querySelector('select[name="fields[jobCategory][]"]').value;
        if (category) formData.append('fields[jobCategory][]', category);

        const description = document.getElementById('jobDescription').value;
        if (description) formData.append('fields[jobDescription]', description);

        const opportunityStatement = document.getElementById('jobOpportunityStatement').value;
        if (opportunityStatement) formData.append('fields[jobOpportunityStatement]', opportunityStatement);

        const salaryLow = document.getElementById('jobSalaryLow').value;
        if (salaryLow) formData.append('fields[jobSalaryLow]', salaryLow);

        const salaryHigh = document.getElementById('jobSalaryHigh').value;
        if (salaryHigh) formData.append('fields[jobSalaryHigh]', salaryHigh);

        const paymentCountry = document.getElementById('hiddenCountry').value;
        if (paymentCountry) formData.append('fields[country]', paymentCountry);

        const paymentCity = document.getElementById('hiddenJobCity').value;
        if (paymentCity) formData.append('fields[jobCity]', paymentCity);

        const paymentState = document.getElementById('hiddenJobState').value;
        if (paymentState) formData.append('fields[jobState]', paymentState);

        const paymentLocation = document.getElementById('hiddenJobLocation').value;
        if (paymentLocation) formData.append('fields[jobLocation]', paymentLocation);

        const applicationInstructions = document.getElementById('jobApplicationInstructions').value;
        if (applicationInstructions) formData.append('fields[jobApplicationInstructions]', applicationInstructions);

        // Add listingOrganization (from hidden field)
        const listingOrgField = document.querySelector('input[name="fields[listingOrganization][]"]');
        if (listingOrgField && listingOrgField.value) {
          formData.append('fields[listingOrganization][]', listingOrgField.value);
        }

        // Submit and redirect to payment
        fetch(form.action, {
          method: 'POST',
          body: formData
        }).then(response => {
          console.log('Entry saved, redirecting to payment');
          window.location.href = '{{ url("jobs/payment") }}?jobId={{ jobEntry.id }}';
        }).catch(error => {
          console.error('Save error:', error);
          alert('There was an error saving your job posting. Please try again.');
        });
      });
    }

    // Add New School functionality (for recruiters)
    const newSchoolCountry = document.getElementById('newSchoolCountry');
    const newSchoolUSFields = document.getElementById('newSchoolUSFields');
    const newSchoolIntlFields = document.getElementById('newSchoolIntlFields');
    const saveNewSchoolBtn = document.getElementById('saveNewSchoolBtn');

    // Show/hide location fields based on country selection
    if (newSchoolCountry) {
      newSchoolCountry.addEventListener('change', function() {
        const newCountry = this.value;
        if (newCountry === 'unitedStates') {
          newSchoolUSFields.style.display = 'block';
          newSchoolIntlFields.style.display = 'none';
        } else if (newCountry === 'international') {
          newSchoolUSFields.style.display = 'none';
          newSchoolIntlFields.style.display = 'block';
        } else {
          newSchoolUSFields.style.display = 'none';
          newSchoolIntlFields.style.display = 'none';
        }
      });
    }

    // Save new school button handler
    if (saveNewSchoolBtn) {
      saveNewSchoolBtn.addEventListener('click', function() {
        const schoolName = document.getElementById('newSchoolName').value.trim();
        const schoolWebsite = document.getElementById('newSchoolWebsite').value.trim();
        const schoolCountry = document.getElementById('newSchoolCountry').value;
        const schoolCity = document.getElementById('newSchoolCity').value.trim();
        const schoolState = document.getElementById('newSchoolState').value;
        const schoolLocation = document.getElementById('newSchoolLocation').value.trim();

        // Validate required fields
        const errors = [];
        if (!schoolName) errors.push('School Name is required');
        if (!schoolCountry) errors.push('Country is required');

        if (schoolCountry === 'unitedStates') {
          if (!schoolCity) errors.push('City is required');
          if (!schoolState) errors.push('State is required');
        } else if (schoolCountry === 'international') {
          if (!schoolLocation) errors.push('Location is required');
        }

        if (errors.length > 0) {
          alert('Please correct the following errors:\n\n' + errors.join('\n'));
          return;
        }

        // Use AJAX to submit school without reloading the page
        const schoolFormData = new FormData();
        schoolFormData.append('CRAFT_CSRF_TOKEN', document.querySelector('input[name="CRAFT_CSRF_TOKEN"]').value);
        schoolFormData.append('action', 'entries/save-entry');
        schoolFormData.append('sectionId', '{{ orgSectionId }}');
        schoolFormData.append('entryTypeId', '{{ orgEntryTypeId }}');
        schoolFormData.append('enabled', '1');
        schoolFormData.append('title', schoolName);
        schoolFormData.append('fields[organizationType]', 'school');
        schoolFormData.append('fields[country]', schoolCountry);

        if (schoolWebsite) {
          let url = schoolWebsite;
          if (!url.match(/^https?:\/\//i)) {
            url = 'https://' + url;
          }
          schoolFormData.append('fields[website]', url);
        }

        if (schoolCountry === 'unitedStates') {
          schoolFormData.append('fields[orgCity]', schoolCity);
          schoolFormData.append('fields[orgState]', schoolState);
        } else if (schoolCountry === 'international') {
          schoolFormData.append('fields[orgLocation]', schoolLocation);
        }

        // Add logo file if one was selected
        const logoInput = document.getElementById('newSchoolLogo');
        if (logoInput && logoInput.files && logoInput.files.length > 0) {
          schoolFormData.append('fields[logo][]', logoInput.files[0]);
        }

        // Disable button and show loading
        saveNewSchoolBtn.disabled = true;
        saveNewSchoolBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        // Submit via AJAX with JSON response
        fetch(window.location.origin, {
          method: 'POST',
          headers: {
            'Accept': 'application/json'
          },
          body: schoolFormData
        })
        .then(response => {
          console.log('Response status:', response.status);
          console.log('Response OK:', response.ok);

          // Parse JSON response
          return response.json();
        })
        .then(data => {
          console.log('JSON response:', data);

          // Extract entry ID from Craft's JSON response
          let entryId = null;

          if (data.id) {
            entryId = data.id;
          } else if (data.entry && data.entry.id) {
            entryId = data.entry.id;
          }

          console.log('Extracted entry ID:', entryId);

          return Promise.resolve({
            ok: true,
            schoolId: entryId,
            schoolName: schoolName,
            schoolCity: schoolCity,
            schoolState: schoolState,
            schoolLocation: schoolLocation,
            schoolCountry: schoolCountry
          });
        })
        .then(data => {
          // Add new school to dropdown
          const schoolSelect = document.getElementById('schoolSelect');
          const newOption = document.createElement('option');

          // Use the school data we collected
          let locationText = '';
          if (data.schoolCountry === 'unitedStates') {
            locationText = ` (${data.schoolCity}, ${data.schoolState})`;
          } else if (data.schoolCountry === 'international') {
            locationText = ` (${data.schoolLocation})`;
          }

          newOption.value = data.schoolId;
          newOption.text = data.schoolName + locationText;

          // Add data attributes for location auto-population
          newOption.setAttribute('data-country', data.schoolCountry || '');
          newOption.setAttribute('data-city', data.schoolCity || '');
          newOption.setAttribute('data-state', data.schoolState || '');
          newOption.setAttribute('data-location', data.schoolLocation || '');

          console.log('Adding school to dropdown with ID:', data.schoolId);

          // Insert alphabetically
          let inserted = false;
          for (let i = 1; i < schoolSelect.options.length; i++) {
            if (schoolSelect.options[i].text.localeCompare(newOption.text) > 0) {
              schoolSelect.add(newOption, schoolSelect.options[i]);
              inserted = true;
              break;
            }
          }
          if (!inserted) {
            schoolSelect.add(newOption);
          }

          // Set as selected AFTER adding to dropdown
          newOption.selected = true;
          console.log('School select current value after adding:', schoolSelect.value);

          // Auto-populate hidden location fields with newly created school's data
          document.getElementById('hiddenCountry').value = data.schoolCountry || '';
          if (data.schoolCountry === 'unitedStates') {
            document.getElementById('hiddenJobCity').value = data.schoolCity || '';
            document.getElementById('hiddenJobState').value = data.schoolState || '';
            document.getElementById('hiddenJobLocation').value = '';
          } else if (data.schoolCountry === 'international') {
            document.getElementById('hiddenJobCity').value = '';
            document.getElementById('hiddenJobState').value = '';
            document.getElementById('hiddenJobLocation').value = data.schoolLocation || '';
          }

          // Clear the form
          document.getElementById('newSchoolName').value = '';
          document.getElementById('newSchoolWebsite').value = '';
          document.getElementById('newSchoolCountry').value = '';
          document.getElementById('newSchoolCity').value = '';
          document.getElementById('newSchoolState').value = '';
          document.getElementById('newSchoolLocation').value = '';
          document.getElementById('newSchoolLogo').value = '';
          newSchoolUSFields.style.display = 'none';
          newSchoolIntlFields.style.display = 'none';

          // Collapse the form
          const collapseElement = document.getElementById('addSchoolCollapse');
          const bsCollapse = bootstrap.Collapse.getInstance(collapseElement) || new bootstrap.Collapse(collapseElement, {toggle: false});
          bsCollapse.hide();

          // Show success
          alert('School added successfully and selected!');
        })
        .catch(error => {
          console.error('Error creating school:', error);
          alert('There was an error creating the school. Please try again.');
        })
        .finally(() => {
          // Re-enable button
          saveNewSchoolBtn.disabled = false;
          saveNewSchoolBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save School & Continue';
        });
      });
    }

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
      // Ensure CKEditor content is synced before submission
      if (jobDescriptionEditor) {
        document.querySelector('#jobDescription').value = jobDescriptionEditor.getData();
      }
      if (opportunityStatementEditor) {
        document.querySelector('#jobOpportunityStatement').value = opportunityStatementEditor.getData();
      }

      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  });
  </script>
  {% endif %}{# end currentUser.isInGroup check #}

  {% endif %}{# end skipJobForm #}

  {% endif %}{# end else (authorized user) #}
      </div>
    </div>
  </div>

{% endblock %}