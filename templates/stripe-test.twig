{% extends "_layout.twig" %}
{% requireLogin %}

{% block title %}Stripe Payment Test · {{ siteName }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px;">
  <div class="card mt-5">
    <div class="card-body p-4">
      <h2 class="h4 mb-3">Stripe Payment System Test</h2>
      <p class="text-muted mb-4">
        This is a test transaction to verify the Stripe integration is working correctly with live keys.
      </p>

      {# Query the $1 test product from Stripe #}
      {% set testPrice = null %}
      {% for product in craft.stripeProducts.all() %}
        {% for price in product.prices %}
          {# Match by amount: 100 cents = $1.00 #}
          {% if price.data.unit_amount == 100 %}
            {% set testPrice = price %}
          {% endif %}
        {% endfor %}
      {% endfor %}

      {% if testPrice %}
        <form method="post">
          {{ csrfInput() }}
          {{ actionInput('stripe/checkout') }}

          {# Hidden field with Stripe Price ID #}
          <input type="hidden" name="lineItems[0][price]" value="{{ testPrice.stripeId }}">
          <input type="hidden" name="lineItems[0][quantity]" value="1">

          {# Success/cancel URLs - must use hash filter for Craft #}
          {{ hiddenInput('successUrl', (url('stripe-test-success'))|hash) }}
          {{ hiddenInput('cancelUrl', (url('stripe-test'))|hash) }}

          <div class="alert alert-info mb-4">
            <strong>Test Details:</strong><br>
            Amount: $1.00<br>
            User: {{ currentUser.email }}<br>
            Product: {{ testPrice.product.title }}<br>
            Price ID: {{ testPrice.stripeId }}
          </div>

          <button type="submit" class="button rounded-pill w-100">
            Process $1.00 Test Payment
          </button>
        </form>
      {% else %}
        <div class="alert alert-warning">
          <strong>$1 test product not found.</strong><br>
          Please ensure:
          <ul class="mb-0 mt-2">
            <li>Product created in Stripe Dashboard</li>
            <li>Price set to $1.00 (100 cents)</li>
            <li>Stripe data synced in Craft (Settings → Stripe → Sync)</li>
          </ul>
        </div>

        <div class="mt-3">
          <p class="small text-muted">
            <strong>Debug: Available products:</strong>
          </p>
          <ul class="small">
          {% for product in craft.stripeProducts.all() %}
            <li>
              {{ product.title }} ({{ product.stripeId }})
              {% for price in product.prices %}
                <br>&nbsp;&nbsp;└─ Price: ${{ (price.data.unit_amount / 100)|number_format(2) }} ({{ price.stripeId }})
              {% endfor %}
            </li>
          {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="mt-4 pt-3 border-top text-center">
        <a href="/profile" class="text-muted">← Back to Profile</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
